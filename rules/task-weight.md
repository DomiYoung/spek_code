# Task Weight Assessment

> 统一使用 planning-with-files，取消 Spec-Kit

---

## 🔴 Stage A: 硬门槛（优先判定）

**不看分数，命中即路由**

```
任务输入
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ 硬门槛检查（按优先级从上到下）                           │
├─────────────────────────────────────────────────────────┤
│ □ Breaking Change?                    → 🟢 planning    │
│ □ Schema/数据迁移?                    → 🟢 planning    │
│ □ 对外 API 契约变化?                  → 🟢 planning    │
│ □ 权限/鉴权/审计/合规?                → 🟢 planning    │
│ □ 资金/结算/订单等高风险?             → 🟢 planning    │
│ □ 跨服务/跨模块链路?                  → 🟢 planning    │
│─────────────────────────────────────────────────────────│
│ □ 需要 >5 次工具调用?                 → 🟢 planning    │
│ □ 多阶段执行?                         → 🟢 planning    │
│ □ 需要持久化进度?                     → 🟢 planning    │
│─────────────────────────────────────────────────────────│
│ □ 纯代码分析/理解?                    → ⚪ TodoWrite   │
│ □ 纯文档/样式?                        → ⚪ TodoWrite   │
└─────────────────────────────────────────────────────────┘
         │
         ▼ (未命中任何硬门槛)
    进入 Stage B
```

---

## 🟡 Stage B: 打分路由

**只在 Stage A 未命中时启用**

### 复杂度评分（只取最高项）

| 条件 | 分数 |
|------|------|
| 新功能/重构/Breaking Change | +10 |
| >5 文件 或 >200 行 | +8 |
| API/架构/Schema 变更 | +7 |
| 3-5 文件功能变更 | +5 |
| 简单 Bug (<3 文件) | +2 |
| 纯样式/文档 | +1 |
| 代码分析/理解 | +0 |

### 风险评分（可叠加，封顶 10）

| 条件 | 分数 |
|------|------|
| 权限/鉴权/审计/合规 | +7 |
| Schema/迁移/数据修复 | +7 |
| 对外 API 契约变化 | +7 |
| 资金/结算/订单等高风险 | +7 |
| 并发/事务/幂等/消息可靠性 | +5 |

### 最终总分

```
总分 = max(复杂度分, 风险分)
```

> 理由：复杂度大或风险大，任一达标都应走重流程

---

## 工作流路由表

| 总分 | 工作流 | 目录 | 说明 |
|------|--------|------|------|
| ≥ 3 | 🟢 planning-with-files | `.planning/` | 统一使用文件持久化规划 |
| 0-2 | ⚪ TodoWrite | 无 | 内存规划 |

---

## 噪音过滤

以下情况直接跳过评估，走 TodoWrite：

- 自动生成的代码
- 纯格式化
- 依赖小版本更新
- 只改 lock 文件

---

## 豁免场景

- 用户明确说"跳过评估"、"直接开始"
- 纯问答对话（非任务执行）

---

## 示例

### 例 1：2 文件但改鉴权

```
输入: changedFiles=2, flags={auth_audit_compliance: true}
Stage A: 命中"权限/鉴权/审计/合规"
结果: 🟢 planning-with-files（硬门槛命中）
```

### 例 2：10 文件但纯格式化

```
输入: changedFiles=10, flags={format_only: true}
噪音过滤: 命中"纯格式化"
结果: ⚪ TodoWrite
```

### 例 3：普通 4 文件 Bug 修复

```
输入: changedFiles=4, flags={bug_fix: true}
Stage A: 未命中
Stage B: 复杂度=5（3-5文件）, 风险=0
总分: max(5, 0) = 5
结果: 🟢 planning-with-files
```
