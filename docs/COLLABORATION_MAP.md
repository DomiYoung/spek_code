# 协同工作机制全景图

> 当前状态分析：配置齐全，但**连接断裂**

---

## 一、理想协同流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户请求                                        │
└─────────────────────────────────┬───────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Layer 0: Claude Code Hooks（自动触发层）                                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │SessionStart │  │UserPrompt   │  │PostToolUse  │  │ SessionEnd  │         │
│  │  Hook       │  │  Hook       │  │  Hook       │  │   Hook      │         │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘         │
└─────────┼────────────────┼────────────────┼────────────────┼────────────────┘
          │                │                │                │
          ▼                ▼                ▼                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Layer 1: 编排层（workflow-orchestrator）                                    │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  Stage A: 硬门槛决策树                                                │   │
│  │  ├── 噪音过滤 → TodoWrite                                            │   │
│  │  ├── 强制升级条件 → Spec-Kit                                         │   │
│  │  └── 继续评估 → Stage B                                              │   │
│  ├──────────────────────────────────────────────────────────────────────┤   │
│  │  Stage B: 打分路由                                                    │   │
│  │  ├── score ≥ 7 → Spec-Kit                                            │   │
│  │  ├── score 3-6 → planning-with-files                                 │   │
│  │  └── score 1-2 → TodoWrite                                           │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────┬───────────────────────────────────────────┘
                                  │
          ┌───────────────────────┼───────────────────────┐
          ▼                       ▼                       ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   Spec-Kit      │     │ planning-with-  │     │   TodoWrite     │
│   工作流         │     │ files 工作流    │     │   直接执行       │
├─────────────────┤     ├─────────────────┤     ├─────────────────┤
│ constitution    │     │ task_plan.md    │     │ 简单任务列表     │
│ specify         │     │ progress.md     │     │                 │
│ plan            │     │ findings.md     │     │                 │
│ tasks           │     │                 │     │                 │
│ implement       │     │                 │     │                 │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Layer 2: 专家路由层                                                         │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐ │
│  │  前端专家   │ │  后端专家   │ │  架构师    │ │  产品经理   │ │  领域专家   │ │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘ └────────────┘ │
└─────────────────────────────────┬───────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Layer 3: 能力层（Skills + MCP）                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  Skills（65+）                                                       │    │
│  │  ├── Spec-Kit 系列（9个）    ├── Patterns（18个）                    │    │
│  │  ├── Task Master（3个）      ├── Experts（7个）                      │    │
│  │  ├── mem-*（2个）            └── Tools（10+个）                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  MCP Servers                                                         │    │
│  │  ├── Serena（符号+记忆）     ├── Context7（文档）                    │    │
│  │  ├── Sequential（推理）      ├── Magic（UI）                         │    │
│  │  ├── Tavily（搜索）          └── Playwright（测试）                  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────┬───────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Layer 4: 记忆层（三套系统）                                                  │
│  ┌────────────────────┐ ┌────────────────────┐ ┌────────────────────┐       │
│  │  本地知识进化        │ │  claude-mem        │ │  Serena Memory     │       │
│  │  ~/.ai-knowledge/   │ │  SQLite+Chroma     │ │  符号化存储         │       │
│  │  ├── pitfalls.md   │ │  ├── observations  │ │  ├── list_memories │       │
│  │  ├── decisions.md  │ │  ├── summaries     │ │  ├── read_memory   │       │
│  │  └── patterns.md   │ │  └── search API    │ │  └── write_memory  │       │
│  │                     │ │                    │ │                    │       │
│  │  触发：知识四问      │ │  触发：Hooks自动   │ │  触发：Session周期 │       │
│  │  写入：SKILL.md     │ │  写入：被动捕获    │ │  写入：检查点/结束  │       │
│  └────────────────────┘ └────────────────────┘ └────────────────────┘       │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、当前断点分析

### 🔴 断点 1: Hooks 配置 vs 实际执行

| 配置文件 | 实际脚本 | 状态 |
|---------|---------|------|
| `triggers.yaml → hooks/session-start.py` | `hooks/session-start-reminder.py` | ❌ 名称不匹配 |
| `triggers.yaml → hooks/task-complete.py` | 不存在 | ❌ 缺失 |
| `triggers.yaml → hooks/pre-commit.py` | 不存在 | ❌ 缺失 |
| `triggers.yaml → hooks/spec-protect.py` | `hooks/protect-specs.py` | ❌ 名称不匹配 |

**实际存在的 hooks：**
- `ai-workflow-router.py` - 工作流路由
- `auto-pitfall-writer.py` - 踩坑自动记录
- `detect-vague-request.py` - 模糊请求检测
- `enforce-workflow-orchestrator.py` - 强制编排器
- `enforce-workflow.py` - 强制工作流
- `guard-git.py` - Git 保护
- `load-knowledge.py` - 知识加载
- `protect-specs.py` - Spec 保护
- `route-workflow.py` - 工作流路由
- `session-start-reminder.py` - 会话开始提醒

### 🔴 断点 2: triggers.yaml 无执行引擎

`configs/triggers.yaml` 是**声明式配置**，但没有**解释器/执行引擎**来读取并执行它。

```
triggers.yaml 定义: "on_start → read pitfalls.md"
                          ↓
                   ❌ 无人执行这个声明
                          ↓
                   实际行为: 不会自动读取
```

### 🔴 断点 3: 三套记忆系统未集成

| 系统 | 写入时机 | 读取时机 | 集成状态 |
|------|---------|---------|---------|
| 本地知识进化 | 知识四问后手动写 | 无自动读取 | ❌ 孤立 |
| claude-mem | Hooks 自动捕获 | MCP tools 搜索 | ⚠️ 已安装但未触发 |
| Serena Memory | Session 周期写入 | Session 开始读取 | ⚠️ 依赖 MCP 调用 |

### 🔴 断点 4: 工作流选择后无自动执行

```
workflow-orchestrator 输出: "使用 Spec-Kit"
                              ↓
                   ❌ 需要手动调用 /speckit.specify
                              ↓
                   期望: 自动进入 Spec-Kit 流程
```

---

## 三、协同机制现状总结

```
┌─────────────────────────────────────────────────────────────────┐
│                        协同状态矩阵                              │
├─────────────────┬──────────────┬──────────────┬────────────────┤
│     组件         │  配置完成度   │  执行连通性   │  实际生效      │
├─────────────────┼──────────────┼──────────────┼────────────────┤
│ Core 框架       │  ✅ 100%     │  ⚠️ 依赖阅读  │  ⚠️ 部分生效   │
│ triggers.yaml   │  ✅ 100%     │  ❌ 无引擎    │  ❌ 不生效     │
│ Hooks 脚本      │  ✅ 有脚本   │  ❌ 未注册    │  ❌ 不生效     │
│ Skills          │  ✅ 65+ 个   │  ⚠️ 手动调用  │  ⚠️ 部分生效   │
│ MCP Servers     │  ✅ 已配置   │  ✅ 自动可用  │  ✅ 生效       │
│ 知识库          │  ✅ 有目录   │  ❌ 无自动读写 │  ❌ 不生效     │
│ claude-mem      │  ✅ 已安装   │  ⚠️ 需启动    │  ⚠️ 待验证     │
└─────────────────┴──────────────┴──────────────┴────────────────┘
```

---

## 四、需要解决的核心问题

### 问题 1: 声明与执行分离

**现状**: 有 `triggers.yaml` 声明规则，但 Claude Code 不会自动读取执行
**方案**:
- A) 将关键触发逻辑写入 `CLAUDE.md`（Claude 每次都读）
- B) 创建 Claude Code hooks.json 注册 Python 脚本
- C) 合并到 workflow-orchestrator SKILL.md 中

### 问题 2: Hooks 未注册到 Claude Code

**现状**: Python 脚本存在但未在 `.claude/hooks.json` 注册
**方案**: 创建 `hooks.json` 将脚本注册为 Claude Code hooks

### 问题 3: 记忆系统各自为政

**现状**: 三套记忆系统没有统一读写协议
**方案**:
- 定义统一的 Session 生命周期
- Session 开始 → 读取所有记忆源
- Session 结束 → 按规则写入对应系统

### 问题 4: 工作流选择后需手动执行

**现状**: 编排器只输出"应该用 Spec-Kit"，不会自动启动
**方案**:
- A) 使用 mem-orchestrator 的子代理模式
- B) 在 SKILL.md 中添加自动执行指令

---

## 五、推荐修复优先级

| 优先级 | 问题 | 修复方案 | 工作量 |
|-------|------|---------|-------|
| P0 | Hooks 未注册 | 创建 hooks.json | 小 |
| P0 | triggers 无引擎 | 合并到 CLAUDE.md | 中 |
| P1 | 记忆系统未集成 | 统一 Session 协议 | 中 |
| P1 | 工作流不自动执行 | 添加执行指令 | 小 |
| P2 | 知识库无自动读取 | Session 开始时加载 | 中 |

---

**结论**: 框架设计完整，但**配置与执行之间存在断裂**。需要一个"胶水层"将声明式配置转化为实际执行。
