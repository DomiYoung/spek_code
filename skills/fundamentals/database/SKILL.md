---
name: fundamentals-database
description: |
  数据库底层原理诊断 - 执行计划/索引/事务/MVCC/锁/存储引擎/SQL 语义。
  Use when:
  - SQL 查询慢/执行计划异常
  - 死锁/锁等待/并发冲突
  - 索引失效/全表扫描/写入慢
  - 一致性/隔离级别问题
  触发词：SQL、索引、执行计划、事务、隔离级别、锁、MVCC、WAL、B-Tree
  Related Skills: experts/database, postgresql-design
allowed-tools: "*"
---

# Database Fundamentals（数据库底层原理）

> **目标**：把“慢/锁/不一致”定位到执行计划、事务或存储引擎层。

## 诊断路径
1. 收集问题 SQL + 表结构 + 索引信息。
2. 查看执行计划（`EXPLAIN/ANALYZE`）。
3. 检查锁等待与并发冲突（锁图/等待时间）。
4. 核对统计信息、隔离级别与事务边界。

## 症状 → 机制速查
- **查询慢** → 误用索引/全表扫描/统计信息过期
- **死锁频发** → 锁顺序不一致或长事务
- **写入慢** → WAL/fsync 压力或索引过多
- **读到旧数据** → 隔离级别或 MVCC 可见性
- **查询计划不稳定** → 参数嗅探/统计偏差

## 关键机制速记
- **优化器**：基于统计信息选择执行计划
- **MVCC**：可见性规则决定读写一致性
- **锁与隔离**：锁粒度与隔离级别影响并发
- **索引结构**：B-Tree 依赖可搜索谓词（SARGable）

## 证据采集要点
- 执行计划、扫描行数、回表次数
- 锁等待时间、阻塞链路
- I/O 与缓存命中率
- 可选：运行 `scripts/diagnose.sh` 输出客户端版本与排查提示

## 常见根因清单
- 条件不可用索引（函数/类型不匹配）
- 缺少联合索引导致回表过多
- 长事务导致锁等待/版本膨胀
- 统计信息过期导致计划错误
- 写放大（过多索引/触发器）

## 快速验证
- `EXPLAIN (ANALYZE, BUFFERS)` 对比实际行数
- 观察锁等待与阻塞链路（锁视图/监控）

## 输出模板（固定顺序）
1. 症状：描述可观测现象与影响范围。
2. 机制：指出机制级根因。
3. 证据：列出采集到的指标/日志/截图/命令输出。
4. 修复：给出最小可行修复与替代方案（如有）。
5. 验证：说明如何确认改善（对比指标/复现/回归）。

## 深入阅读（按需加载）
- `references/MECHANICS.md`：执行计划、索引、事务与锁
