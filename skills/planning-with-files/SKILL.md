---
name: planning-with-files
description: |
  文件持久化规划工具 - 多轮对话式中等复杂度任务规划。
  Use when:
  - 任务权重 3-6 分（多文件变更但非架构级）
  - 需要 >5 次工具调用的多步骤任务
  - 研究性任务需要记录发现和进度
  - 任务可能跨 Session 需要持久化状态
  触发词：规划、计划、多步骤、复杂任务、进度跟踪、.planning
  Related Skills: brainstorm, speckit.specify, workflow-orchestrator
globs:
  - ".planning/**/*"
  - "**/task_plan.md"
  - "**/progress.md"
  - "**/findings.md"
---

# Planning with Files

> **Skill 类型**：Dialogue-driven（对话驱动型）
> **核心理念**：先讨论方案，确认后再持久化到文件系统。

```
Context Window = RAM (易失、有限)
Filesystem = Disk (持久、无限)
```

---

## Quick Start

```
方案讨论(2-3轮) → 确认方案 → 创建 task_plan.md → 执行 → 更新 progress.md
```

---

## 核心流程（The Process）

### Phase 0: 方案讨论（2-3 轮）

**在创建任何文件之前，先讨论方案**：

**提问原则**：
- **一次一问** - 每条消息只包含一个问题
- **选择题优先** - 提供 2-3 个选项让用户选择

**追问焦点**：
```
第 1 轮：目标确认 - "这个任务的核心目标是什么？"
第 2 轮：方案选择 - "有几种实现方式，推荐方案 A，你觉得呢？"
第 3 轮：风险识别 - "可能遇到的阻塞点是什么？"
```

**方案呈现格式**：
```markdown
我建议采用以下方案：

**核心思路**：[1-2 句]

**步骤分解**：
1. [步骤1] - 预计 [时间]
2. [步骤2] - 预计 [时间]
3. [步骤3] - 预计 [时间]

**潜在风险**：[简述]

这个方案可以吗？还是需要调整？
```

### Phase 1: 确认后创建文件

**用户确认方案后，才创建规划文件**：

```bash
mkdir -p .planning
```

**输出确认卡片**：
```
╔════════════════════════════════════════════════════════╗
║  📋 规划已创建                                          ║
╠════════════════════════════════════════════════════════╣
║  目录: .planning/                                       ║
║  计划: task_plan.md                                     ║
║  步骤: [N] 个                                           ║
║  ──────────────────────────────────────────────────── ║
║  🚀 准备开始执行吗？                                    ║
╚════════════════════════════════════════════════════════╝
```

### Phase 2: 执行与更新

执行时实时更新进度：

| 时机 | 操作 | 文件 |
|------|------|------|
| 完成步骤 | 更新状态 | progress.md |
| 发现问题 | 记录发现 | findings.md |
| 方案变更 | 更新计划 | task_plan.md |

### Phase 3: 门控完成

任务完成后，**必须询问**：

```markdown
---
任务已完成 ✓

**执行摘要**：
- 完成步骤: [N]/[总数]
- 关键发现: [N] 项
- 耗时: [估算]

**下一步选择**：
1. 📝 查看完整 progress.md
2. 🗑️ 清理 .planning/ 目录
3. 📤 迁移发现到项目文档
4. 🔄 还有后续任务

请选择 (1/2/3/4)：
```

---

## 目录结构

```
.planning/
├── task_plan.md      # 任务计划（必需）
├── progress.md       # 执行进度（推荐）
└── findings.md       # 关键发现（可选）
```

---

## 文件模板

### task_plan.md

```markdown
# Task Plan: [任务标题]

## 目标
[简述任务目标]

## 方案确认
- 确认时间: [时间戳]
- 讨论轮次: [N] 轮

## 任务分解

- [ ] 1. [步骤1]
- [ ] 2. [步骤2]
- [ ] 3. [步骤3]

## 依赖关系
- 步骤2 依赖 步骤1
- 步骤3 依赖 步骤2

## 风险和注意事项
- [潜在风险]

## 完成标准
- [ ] [验收条件1]
- [ ] [验收条件2]
```

### progress.md

```markdown
# Progress Log

## [时间戳] 步骤1
- 状态: ✅ 完成 / 🔄 进行中 / ❌ 阻塞
- 产出: [文件/结果]
- 备注: [关键信息]
```

### findings.md

```markdown
# Key Findings

## 发现1: [标题]
- 来源: [文件/调查]
- 影响: [对任务的影响]
- 行动: [需要采取的行动]
```

---

## 关键规则

### ✅ DO

1. **先讨论方案** - 确认后再创建文件
2. **一次一问** - 不要用多个问题轰炸用户
3. **每完成一步** - 立即更新 progress.md
4. **发现问题** - 记录到 findings.md
5. **上下文切换前** - 确保进度已保存

### ❌ DON'T

1. 不要跳过方案讨论直接创建文件
2. 不要仅依赖 TodoWrite（易失）
3. 不要在对话中隐藏错误
4. 不要在完成前删除 .planning/

---

## 与其他工作流的关系

| 权重 | 工作流 | 说明 |
|------|--------|------|
| ≥ 3 | **planning-with-files** | 统一使用 .planning/ 流程 |
| 0-2 | TodoWrite | 无持久化，内存规划 |

---

## Critical Guidelines

1. **🔴 AskUserQuestion 强制** - 方案确认必须使用 AskUserQuestion 工具
2. **先讨论后创建** - 2-3 轮确认方案再创建文件
3. **一次一问** - 不要用多个问题轰炸用户
4. **选择题优先** - 比开放式问题更容易回答
5. **门控完成** - 任务完成后询问下一步
6. **即时保存** - 每个步骤完成后立即更新文件
7. **禁止跳过确认** - 不能直接创建文件，必须先讨论方案
