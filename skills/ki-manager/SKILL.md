---
name: ki-manager
description: |
  知识智能管理器 - 统一经验沉淀入口，支持 SPEK 自进化系统。
  ① 帮我干什么：自动评估知识价值、写入 pitfalls.md、更新快速索引
  ② 什么时候出场：Bug 修复后、调试 > 15min、用户说"踩坑/记录"、会话结束前
  ③ 和项目有无关系：适用于所有项目，是全局通用的知识沉淀器
globs:
  - "**/*"
triggers:
  - "踩坑"
  - "记录"
  - "pitfall"
  - "bug 修复完成"
  - "调试了很久"
---

# KI Manager（知识智能管理器）

> **Skill 类型**：Evolution-based（进化型）
> **核心理念**：不只是记录，而是让 AI 从错误中自动学习。每次踩坑都是进化的燃料。

---

## Quick Start

```
触发条件 → Step 1: 知识价值评估 → Step 2: 分类判定 → Step 3: 写入知识库 → Step 4: 更新索引
```

---

## 触发条件

| 条件 | 自动/手动 | 说明 |
|------|----------|------|
| Bug 修复完成 | 自动 | 任务类型为 Bug 修复且状态变为完成 |
| 调试 > 15 分钟 | 自动 | 检测到长时间调试对话 |
| 用户说"踩坑" | 手动 | 关键词触发 |
| 用户说"记录一下" | 手动 | 关键词触发 |
| 会话即将结束 | 自动 | 检测到 /exit 或长时间无响应 |
| 同一错误出现 2+ 次 | 自动 | 死循环检测 |

---

## Step 1: 知识价值评估（8 维度）

### 输出格式

```
╔════════════════════════════════════════════════════════════╗
║  🧠 知识价值评估                                            ║
╠════════════════════════════════════════════════════════════╣
║  维度                    │  权重  │  命中  │  得分          ║
╠──────────────────────────┼────────┼────────┼───────────────╣
║  🔍 隐蔽性（不易发现）    │  +1    │  [ ]   │               ║
║  ⏱️ 耗时性（> 15 分钟）   │  +1    │  [ ]   │               ║
║  🔄 复发性（出现 2+ 次）  │  +2    │  [ ]   │               ║
║  🌐 跨项目（可复用）      │  +1    │  [ ]   │               ║
║  🤯 反直觉（违背预期）    │  +1    │  [ ]   │               ║
║  📚 教育性（有学习价值）  │  +1    │  [ ]   │               ║
║  🔗 关联性（可形成网络）  │  +1    │  [ ]   │               ║
║  🛡️ 预防性（可防未来）    │  +1    │  [ ]   │               ║
╠──────────────────────────┴────────┴────────┴───────────────╣
║  📊 总分: [X] / 10                                          ║
║  🎯 判定: [强制记录 ≥5 / 建议记录 3-4 / 可选记录 1-2]       ║
╚════════════════════════════════════════════════════════════╝
```

### 判定规则

| 总分 | 判定 | 动作 |
|------|------|------|
| **≥ 5** | ⭐⭐⭐ 强制记录 | 必须写入，无需确认 |
| **3-4** | ⭐⭐ 建议记录 | 询问用户是否记录 |
| **1-2** | ⭐ 可选记录 | 提示可记录，用户决定 |
| **0** | 跳过 | 不触发记录流程 |

---

## Step 2: 分类判定

### 知识类型

| 类型 | 目标文件 | 适用场景 |
|------|---------|---------|
| **踩坑记录** | `pitfalls.md` | 错误、Bug、陷阱 |
| **架构决策** | `decisions.md` | ADR、技术选型 |
| **组件模式** | `patterns.md` | 可复用的代码模式 |

### 存储层级

| 层级 | 路径 | 条件 |
|------|------|------|
| **全局** | `~/.ai-knowledge/global/` | 跨项目可复用（🌐 命中） |
| **领域** | `~/.ai-knowledge/domains/{domain}/` | 技术栈特定 |
| **项目** | `~/.ai-knowledge/projects/{project}/` | 项目特定 |

---

## Step 3: 写入知识库

### Pitfall 标准格式

```markdown
### [YYYY-MM-DD] 问题简述

**现象**: 具体表现是什么

**根因**: 为什么会发生
\`\`\`typescript
// ❌ 错误写法
const bad = ...

// ✅ 正确写法
const good = ...
\`\`\`

**修复**: 怎么解决的

**预防**:
- [ ] 检查项 1
- [ ] 检查项 2

**适用项目**: [所有项目 / 特定项目名]
```

### 自动写入流程

```python
# 伪代码
def write_pitfall(content, level, domain=None):
    if level == "global":
        path = "~/.ai-knowledge/global/pitfalls.md"
    elif level == "domain":
        path = f"~/.ai-knowledge/domains/{domain}/pitfalls.md"
    else:
        path = f"~/.ai-knowledge/projects/{project}/pitfalls.md"
    
    # 追加到文件末尾
    append_to_file(path, content)
    
    # 更新快速索引
    update_index(path)
```

---

## Step 4: 更新快速索引

每次写入后，更新文件头部的索引表：

```markdown
## 📋 快速索引

| 分类 | 条目数 | 最近更新 |
|------|--------|----------|
| 环境配置 | 2 | 2026-01-09 |
| 代码模式 | 3 | 2026-01-08 |
| 框架陷阱 | 1 | 2026-01-05 |
```

---

## 与其他 Skill 协作

```
workflow-orchestrator
        │
        ▼ (任务完成后触发)
   ki-manager
        │
        ├─→ 评估知识价值
        ├─→ 写入 pitfalls.md
        └─→ 通知 skill-evolution-agent (如有)
```

---

## 使用示例

### 示例 1: 自动触发

```
用户: "终于修好了这个 bug，折腾了半小时"
AI: 检测到 Bug 修复 + 耗时 > 15 分钟，触发 ki-manager...

╔════════════════════════════════════════════════════════════╗
║  🧠 知识价值评估                                            ║
╠════════════════════════════════════════════════════════════╣
║  ⏱️ 耗时性（> 15 分钟）   │  +1    │  [✓]  │  1            ║
║  🔍 隐蔽性（不易发现）    │  +1    │  [✓]  │  1            ║
║  🛡️ 预防性（可防未来）    │  +1    │  [✓]  │  1            ║
╠──────────────────────────────────────────────────────────╣
║  📊 总分: 3 / 10                                            ║
║  🎯 判定: ⭐⭐ 建议记录                                      ║
╚════════════════════════════════════════════════════════════╝

是否记录到 pitfalls.md？[Y/n]
```

### 示例 2: 手动触发

```
用户: "这个坑要记录一下"
AI: 触发 ki-manager，开始知识价值评估...
```

---

## 红线规则

| 规则 | 状态 |
|------|------|
| 评分 ≥ 5 必须记录，不可跳过 | ❌ **Forbidden** to skip |
| 必须使用标准格式 | ❌ **Forbidden** 自由格式 |
| 必须更新快速索引 | ❌ **Forbidden** 只追加不更新索引 |
| 敏感信息（密码、Key）禁止记录 | ❌ **Forbidden** |

---

## 自检清单

- [ ] 是否输出了 8 维度评估表格？
- [ ] 是否正确判定存储层级？
- [ ] 是否使用标准格式写入？
- [ ] 是否更新了快速索引？
- [ ] 是否排除了敏感信息？
